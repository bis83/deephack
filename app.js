(()=>{const c=()=>document.getElementById("main"),d=()=>{const i=document.getElementById("message");i.style.display="none"},h={};h.createVertexShader=(i,t)=>{let e=i.createShader(i.VERTEX_SHADER);if(i.shaderSource(e,t),i.compileShader(e),i.getShaderParameter(e,i.COMPILE_STATUS))return e;console.log(t),console.log(i.getShaderInfoLog(e)),i.deleteShader(e)};h.createFragmentShader=(i,t)=>{let e=i.createShader(i.FRAGMENT_SHADER);if(i.shaderSource(e,t),i.compileShader(e),i.getShaderParameter(e,i.COMPILE_STATUS))return e;console.log(t),console.log(i.getShaderInfoLog(e)),i.deleteShader(e)};h.createProgram=(i,t,e)=>{let r=h.createVertexShader(i,t),s=h.createFragmentShader(i,e),o=i.createProgram();if(i.attachShader(o,r),i.attachShader(o,s),i.linkProgram(o),i.getProgramParameter(o,i.LINK_STATUS))return o;console.log(i.getProgramInfoLog(o)),i.deleteProgram(o)};h.loadImageAsync=i=>new Promise((t,e)=>{let r=new Image;r.onload=()=>t(r),r.onerror=e,r.src=i});h.loadTextureAsync=async(i,t)=>{let e=await h.loadImageAsync(t),r=i.createTexture();return i.bindTexture(i.TEXTURE_2D,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e),r};h.whiteTexture=i=>{let t=i.createTexture();return i.bindTexture(i.TEXTURE_2D,t),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,1,1,0,i.RGBA,i.UNSIGNED_BYTE,new Uint8Array(4).fill(255)),t};class u{constructor(){this.keyMap={ArrowLeft:0,ArrowRight:1,ArrowUp:2,ArrowDown:3,Space:4},this.keyState=new Array(5).fill(!1),this.keyStateCount=new Array(5).fill(0),document.addEventListener("keydown",t=>{const e=this.keyMap[t.code];e!==null&&(this.keyState[e]=!0,t.preventDefault())}),document.addEventListener("keyup",t=>{const e=this.keyMap[t.code];e!==null&&(this.keyState[e]=!1,t.preventDefault())}),document.addEventListener("blur",t=>{this.keyState.fill(!1)})}update(){for(let t=0;t<5;++t)this.keyStateCount[t]=this.keyState[t]?this.keyStateCount[t]+1:0}left(){return this.keyStateCount[0]>0}right(){return this.keyStateCount[1]>0}up(){return this.keyStateCount[2]>0}down(){return this.keyStateCount[3]>0}decide(){return this.keyStateCount[4]==1}}class m{constructor(t){this.gl=t,this.vs=`#version 300 es
        uniform mat4 world;
        uniform mat4 projection;
        uniform vec4 texcoord;
        out vec2 uv;
        void main() {
            float x = (gl_VertexID & 0x1) == 0 ? -0.5 : +0.5;
            float y = (gl_VertexID & 0x2) == 0 ? -0.5 : +0.5;
            gl_Position = projection * world * vec4(x, y, 0.0, 1.0);
            float u = (gl_VertexID & 0x1) == 0 ? texcoord.x : texcoord.z;
            float v = (gl_VertexID & 0x2) == 0 ? texcoord.w : texcoord.y;
            uv = vec2(u,v);
        }`,this.fs=`#version 300 es
        precision mediump float;
        uniform vec4 mainColor;
        uniform sampler2D textureColor;
        in vec2 uv;
        out vec4 finalColor;
        void main() {
            finalColor = mainColor * texture(textureColor, uv);
        }`,this.program=h.createProgram(this.gl,this.vs,this.fs),this.world=this.gl.getUniformLocation(this.program,"world"),this.worldValue=mat4.create(),this.projection=this.gl.getUniformLocation(this.program,"projection"),this.projectionValue=mat4.create(),this.texcoord=this.gl.getUniformLocation(this.program,"texcoord"),this.texcoordValue=vec4.fromValues(0,0,1,1),this.mainColor=this.gl.getUniformLocation(this.program,"mainColor"),this.mainColorValue=vec4.fromValues(1,1,1,1),this.textureColor=this.gl.getUniformLocation(this.program,"textureColor"),this.textureColorValue="",this.blendMode=0,this.textures=new Map,this.textures.white=h.whiteTexture(this.gl)}load(t){this.textures[t]==null&&(this.textures[t]="loading",h.loadTextureAsync(this.gl,t).then(e=>{this.textures[t]=e}))}ortho(t,e,r,s){mat4.ortho(this.projectionValue,t,e,r,s,-1,1)}trans(t,e,r,s,o){const a=mat4.create();mat4.fromZRotation(a,o);const l=mat4.create();mat4.fromScaling(l,vec3.fromValues(r,s,1));const n=mat4.create();mat4.fromTranslation(n,vec3.fromValues(t,e,1)),mat4.mul(this.worldValue,a,l),mat4.mul(this.worldValue,n,this.worldValue)}color(t,e,r,s){vec4.set(this.mainColorValue,t,e,r,s)}texture(t){this.textureColorValue=t}getTexture(){let t=this.textures[this.textureColorValue];return t==="loading"&&(t=null),t||this.textures.white}uv(t,e,r,s){vec4.set(this.texcoordValue,t,e,r,s)}blend(t){this.blendMode=t}draw(){this.gl.disable(this.gl.DEPTH_TEST),this.gl.enable(this.gl.BLEND),this.blendMode==0?this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA):this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE),this.gl.useProgram(this.program),this.gl.uniformMatrix4fv(this.world,!1,this.worldValue),this.gl.uniformMatrix4fv(this.projection,!1,this.projectionValue),this.gl.uniform4fv(this.texcoord,this.texcoordValue),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.getTexture()),this.gl.uniform1i(this.textureColor,0),this.gl.uniform4fv(this.mainColor,this.mainColorValue),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}}class p{constructor(t){this.gl=t,this.vs=`#version 300 es
        in vec3 position;
        in vec2 texcoord;
        uniform mat4 world;
        uniform mat4 projection;
        uniform vec3 center;
        out vec2 uv;
        void main() {
            gl_Position = projection * world * vec4(position + center, 1.0);
            uv = vec2(texcoord.x, 1.0 - texcoord.y);
        }`,this.fs=`#version 300 es
        precision mediump float;
        uniform sampler2D textureColor;
        in vec2 uv;
        out vec4 finalColor;
        void main() {
            finalColor = texture(textureColor, uv);
        }`,this.program=h.createProgram(this.gl,this.vs,this.fs),this.positionAttribute=this.gl.getAttribLocation(this.program,"position"),this.texcoordAttribute=this.gl.getAttribLocation(this.program,"texcoord"),this.center=this.gl.getUniformLocation(this.program,"center"),this.world=this.gl.getUniformLocation(this.program,"world"),this.worldValue=mat4.create(),this.projection=this.gl.getUniformLocation(this.program,"projection"),this.projectionValue=mat4.create(),this.textureColor=this.gl.getUniformLocation(this.program,"textureColor"),this.modelValue="",this.models=new Map,this.textures=new Map,this.textures.white=h.whiteTexture(this.gl)}load(t){this.models[t]==null&&(this.models[t]=[],fetch(t).then(e=>e.json()).then(e=>{for(const r of e){const s=this.gl.createVertexArray();this.gl.bindVertexArray(s);const o=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,o),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(r.vertex),this.gl.STATIC_DRAW),this.gl.enableVertexAttribArray(this.positionAttribute),this.gl.vertexAttribPointer(this.positionAttribute,3,this.gl.FLOAT,!1,20,0),this.gl.enableVertexAttribArray(this.texcoordAttribute),this.gl.vertexAttribPointer(this.texcoordAttribute,2,this.gl.FLOAT,!1,20,12);const a=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,a),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(r.index),this.gl.STATIC_DRAW),this.gl.bindVertexArray(null),this.loadTexture(r.texture),this.models[t].push({vao:s,buffer0:o,ibuffer:a,count:r.index.length,center:vec3.fromValues(r.center[0],r.center[1],r.center[2]),texture:r.texture})}}))}loadTexture(t){this.textures[t]==null&&(this.textures[t]="loading",h.loadTextureAsync(this.gl,t).then(e=>{this.textures[t]=e}))}getTexture(t){let e=this.textures[t];return e==="loading"&&(e=null),e||this.textures.white}model(t){this.modelValue=t}trans(t,e,r,s){const o=mat4.create();mat4.fromScaling(o,vec3.fromValues(t,t,t));const a=mat4.create();mat4.fromZRotation(a,s);const l=mat4.create();mat4.fromTranslation(l,vec3.fromValues(e,r,0)),mat4.mul(this.worldValue,a,o),mat4.mul(this.worldValue,l,this.worldValue)}ortho(t,e,r,s){mat4.ortho(this.projectionValue,t,e,r,s,-100,100)}draw(){this.gl.enable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.BLEND),this.gl.useProgram(this.program),this.gl.uniformMatrix4fv(this.world,!1,this.worldValue),this.gl.uniformMatrix4fv(this.projection,!1,this.projectionValue);const t=this.models[this.modelValue];for(const e of t)this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.getTexture(e.texture)),this.gl.uniform1i(this.textureColor,0),this.gl.uniform3fv(this.center,e.center),this.gl.bindVertexArray(e.vao),this.gl.drawElements(this.gl.TRIANGLES,e.count,this.gl.UNSIGNED_SHORT,0),this.gl.bindVertexArray(null)}}class f{constructor(){this.hiscore=12261,this.wait=0,this.reset()}reset(){this.score=12261,this.life=3*60*60,this.x=5,this.y=4,this.dir=1,this.displayBias=0,this.isGameOver=!1,this.isGameStart=!1,this.speed=.01,this.isSpeedUp=!1,this.particleBooster=[],this.particleDestroy=[],this.fillRocks()}fillRocks(){this.rocks=[];for(let t=0;t<13;++t){let e=[];for(let r=0;r<9;++r)e.push({type:0,life:50});this.rocks.push(e)}for(let t=0;t<this.x+1;++t)this.rocks[t][this.y].life=0}onload(t,e){e.sprite.load("img/title.png"),e.sprite.load("img/drillui.png"),e.model.load("json/drill.json"),e.model.load("json/rock_a.json"),e.model.load("json/rock_b.json")}update(t){if(!this.isGameStart){this.updateStart(t);return}if(this.isGameOver){this.updateGameOver(t);return}this.updateMain(t)}updateStart(t){t.decide()&&(this.isGameStart=!0)}updateMain(t){if(this.wait>0){this.wait-=1;return}this.dirDrill(t),t.decide()&&this.speedUpDrill(),this.attackDrill(),this.speedDownDrill(),this.consumeDrill(),this.scrollRocks()}gameOver(){this.isGameOver=!0,this.wait=120,this.hiscore<this.score&&(this.hiscore=this.score)}dirDrill(t){t.up()?(this.dir=0,this.y<=0&&(this.dir=1)):t.down()?(this.dir=2,this.y>=8&&(this.dir=1)):this.dir=1}speedUpDrill(){this.speed<.5&&(this.isSpeedUp=!0,this.speed+=.01,this.emitParticleBooster(50,40))}attackDrill(){const t=this.speed*100+(this.isSpeedUp?50:0);this.isSpeedUp=!1;let e=this.x+(this.dir==1||this.y%2!=0?1:0),r=this.y+this.dir-1;e>=12||(this.rocks[e][r].life>0&&(this.rocks[e][r].life-=t,this.rocks[e][r].life<=0?this.emitPartcleDestroy(50,50):this.emitPartcleDestroy(4,30)),this.rocks[e][r].life<=0&&(this.x=e,this.y=r,(this.y<=0||this.y>=8)&&(this.dir=1)))}speedDownDrill(){this.life%30==0&&this.speed>.01&&(this.speed-=.01)}consumeDrill(){this.life-=1,this.life<0&&this.gameOver()}scrollRocks(){this.displayBias+=this.speed,this.score+=100*this.speed,this.displayBias>=1&&(this.nextRocks(),this.displayBias=0)}nextRocks(){this.x-=1,this.x<0&&this.gameOver(),this.rocks.shift();let t=[];for(let e=0;e<9;++e)Math.random()<.1?t.push({type:1,life:1e3}):t.push({type:0,life:50});this.rocks.push(t)}updateGameOver(t){if(this.wait>0){this.wait-=1;return}t.decide()&&this.reset()}emitParticleBooster(t,e){const r=2*Math.PI*(30-this.dir*30)/360;for(let s=0;s<t;++s){const o=2*Math.PI*Math.random(),a=e*Math.random(),l=this.x*60-60*this.displayBias-(this.y%2==0?30:0),n=480-this.y*60-(2-Math.floor(Math.random()*4));this.particleBooster.push({life:5+Math.floor(Math.random()*35),x:l+a*Math.cos(o)-50*Math.cos(r),y:n+.5*a*Math.sin(o)-50*Math.sin(r)})}}emitPartcleDestroy(t,e){const r=2*Math.PI*(30-this.dir*30)/360;for(let s=0;s<t;++s){const o=2*Math.PI*Math.random(),a=e*Math.random(),l=this.x*60-60*this.displayBias-(this.y%2==0?30:0),n=480-this.y*60-(2-Math.floor(Math.random()*4));this.particleDestroy.push({life:4+Math.floor(Math.random()*10),x:l+.75*a*Math.cos(o)+40*Math.cos(r),y:n+a*Math.sin(o)+40*Math.sin(r)})}}stepParticles(){for(let t of this.particleBooster)t.life-=1,t.x-=this.speed*50;for(let t of this.particleDestroy)t.life-=1,t.x-=this.speed*50;this.particleBooster=this.particleBooster.filter(t=>t.life>0),this.particleDestroy=this.particleDestroy.filter(t=>t.life>0)}draw(t){this.drawBackground(t),this.drawRocks(t),this.drawDrillTank(t),this.stepParticles(),this.drawParticles(t),this.drawHud(t)}drawBackground(t){t.sprite.texture("img/drillui.png"),t.sprite.color(1,1,1,1),t.sprite.trans(320,240,640,480,0),t.sprite.uv(0,480/1024,640/1024,960/1024),t.sprite.draw()}drawRocks(t){for(let e=0;e<this.rocks.length;++e)for(let r=0;r<this.rocks[e].length;++r){if(this.rocks[e][r].life<=0)continue;this.rocks[e][r].type==0?t.model.model("json/rock_a.json"):t.model.model("json/rock_b.json");const s=e*60-60*this.displayBias-(r%2==0?30:0),o=480-r*60;t.model.trans(25,s,o,0),t.model.draw()}}drawDrillTank(t){t.model.model("json/drill.json");const e=this.x*60-60*this.displayBias-(this.y%2==0?30:0)-(2-Math.floor(Math.random()*4)),r=480-this.y*60-(2-Math.floor(Math.random()*4)),s=2*Math.PI*(40-this.dir*40)/360;t.model.trans(20,e,r,s),t.model.draw()}drawParticles(t){t.sprite.blend(1),t.sprite.texture("img/drillui.png"),t.sprite.color(1,1,1,1),t.sprite.uv(640/1024,72/1024,648/1024,80/1024);for(const e of this.particleBooster)t.sprite.trans(e.x,e.y,8,8,0),t.sprite.draw();t.sprite.uv(648/1024,72/1024,656/1024,80/1024);for(const e of this.particleDestroy)t.sprite.trans(e.x,e.y,8,8,0),t.sprite.draw();t.sprite.blend(0)}drawHud(t){t.sprite.texture("img/drillui.png"),t.sprite.uv(0,0,640/1024,480/1024),t.sprite.color(1,1,1,1),t.sprite.trans(320,240,640,480,0),t.sprite.draw(),this.drawLifeBar(t),this.drawSpeedBar(t),this.drawDepthBar(t),this.isGameStart||this.drawTitle(t),this.isGameOver&&this.drawGameOver(t)}drawLifeBar(t){t.sprite.texture("img/drillui.png"),t.sprite.uv(640/1024,4/1024,644/1024,24/1024),t.sprite.color(1,1,1,1);const e=Math.floor(this.life/180);for(let r=0;r<e;++r)t.sprite.trans(320+6*r-178,240-228,4,20,0),t.sprite.draw()}drawSpeedBar(t){t.sprite.texture("img/drillui.png"),t.sprite.uv(640/1024,0/1024,704/1024,4/1024),t.sprite.color(1,1,1,1);const e=Math.floor(this.speed*100);for(let r=0;r<e;++r)t.sprite.trans(320-244,240+6*r-214,64,4,0),t.sprite.draw()}drawDepthBar(t){t.sprite.texture("img/drillui.png"),t.sprite.uv(640/1024,24/1024,656/1024,40/1024),t.sprite.color(1,1,1,1),t.sprite.trans(320+312,240+220-450*(this.score/26e5),16,16,0),t.sprite.draw(),this.drawNumber(t,320+140,240+208,this.score)}drawNumber(t,e,r,s){t.sprite.texture("img/drillui.png"),t.sprite.color(1,1,1,1);const o=7;for(let a=0;a<o;++a){const l=Math.floor(s/Math.pow(10,o-a-1))%10,n=640+l*20;t.sprite.uv(n/1024,40/1024,(n+20)/1024,(40+32)/1024),t.sprite.trans(e+a*20,r,20,32,0),t.sprite.draw()}}drawTitle(t){t.sprite.texture("img/title.png"),t.sprite.uv(0,0,640/1024,480/1024),t.sprite.color(1,1,1,1),t.sprite.trans(320,240,640,480,0),t.sprite.draw()}drawGameOver(t){t.sprite.texture("img/title.png"),t.sprite.uv(0,480/1024,640/1024,960/1024),t.sprite.color(1,1,1,1),t.sprite.trans(320,240,640,480,0),t.sprite.draw()}}class g{constructor(){this.canvas=c(),this.gl=this.canvas.getContext("webgl2"),this.fx={sprite:new m(this.gl),model:new p(this.gl)},this.input=new u,this.scene=new f,this.scene.onload(this.input,this.fx),d()}draw(){const t=window.innerWidth;t!==this.gl.canvas.width&&(this.gl.canvas.width=t);const e=window.innerHeight;e!==this.gl.canvas.height&&(this.gl.canvas.height=e),this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height),this.gl.clearColor(0,0,0,0),this.gl.clearDepth(1),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);const r=640,s=480;this.gl.viewport((this.gl.canvas.width-r)/2,(this.gl.canvas.height-s)/2,r,s),this.fx.sprite.ortho(0,r,0,s),this.fx.model.ortho(0,r,0,s),this.scene.draw(this.fx)}loop(){requestAnimationFrame(()=>this.loop()),this.input.update(),this.scene.update(this.input),this.draw()}}window.onload=()=>{new g().loop()};})();
